<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aelim Son's English Vocabook</title>

  <!-- Core (í•­ìƒ í•„ìš”) -->
  <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
  <script src="https://unpkg.com/docxtemplater@3.45.0/build/docxtemplater.js"></script>

  <style>
    /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif;
      background: #f0f4f8;
      color: #1a202c;
      min-height: 100vh;
    }

    /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: linear-gradient(135deg, #1a365d 0%, #2c5282 60%, #2b6cb0 100%);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .header-logo { font-size: 1.8rem; }
    .header-title { font-size: 1.25rem; font-weight: 800; color: #fff; letter-spacing: -0.3px; }
    .header-sub  { font-size: 0.72rem; color: rgba(255,255,255,0.6); margin-top: 1px; }
    .header-badge {
      background: rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.9);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.2);
    }

    /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container { max-width: 1040px; margin: 0 auto; padding: 28px 20px 60px; }

    /* â”€â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 22px 26px;
      margin-bottom: 18px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.07), 0 4px 12px rgba(0,0,0,0.04);
    }
    .card-label {
      font-size: 0.78rem;
      font-weight: 700;
      color: #a0aec0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 12px;
    }

    /* â”€â”€â”€ Settings Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .settings-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media (max-width: 660px) { .settings-row { grid-template-columns: 1fr; } }

    /* â”€â”€â”€ Input Group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-row { display: flex; gap: 8px; }
    .input-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.88rem;
      font-family: monospace;
      transition: border-color 0.2s;
      background: #fafafa;
    }
    .input-row input:focus { outline: none; border-color: #4299e1; background: #fff; }

    /* â”€â”€â”€ Template Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tmpl-zone {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border: 1.5px dashed #cbd5e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    .tmpl-zone:hover { border-color: #4299e1; background: #ebf8ff; }
    .tmpl-zone.loaded  { border-color: #48bb78; border-style: solid; background: #f0fff4; }
    .tmpl-zone-icon { font-size: 1.6rem; }
    .tmpl-zone-text { font-size: 0.85rem; color: #718096; }
    .tmpl-zone.loaded .tmpl-zone-text { color: #276749; font-weight: 600; }

    /* â”€â”€â”€ Placeholder Guide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .guide-box {
      margin-top: 10px;
      padding: 10px 14px;
      background: #fffbeb;
      border: 1px solid #f6e05e;
      border-radius: 8px;
      font-size: 0.78rem;
      color: #744210;
      line-height: 1.7;
    }
    .guide-box code {
      background: #fef3c7;
      padding: 1px 5px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85em;
    }

    /* â”€â”€â”€ Tab Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-bar {
      display: flex;
      gap: 2px;
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 22px;
      border: none;
      background: transparent;
      font-size: 0.88rem;
      font-weight: 700;
      color: #718096;
      cursor: pointer;
      border-radius: 10px 10px 0 0;
      margin-bottom: -2px;
      border-bottom: 2px solid transparent;
      transition: all 0.18s;
      white-space: nowrap;
    }
    .tab-btn:hover { color: #2b6cb0; background: #ebf8ff; }
    .tab-btn.active { color: #2b6cb0; border-bottom-color: #4299e1; background: #ebf8ff; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€â”€ Drop Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .drop-zone {
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      padding: 36px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
      user-select: none;
    }
    .drop-zone:hover, .drop-zone.over { border-color: #4299e1; background: #ebf8ff; }
    .drop-zone input[type="file"] { display: none; }
    .dz-icon { font-size: 2.4rem; margin-bottom: 10px; }
    .dz-text { color: #718096; font-size: 0.9rem; margin-bottom: 4px; }
    .dz-hint { color: #a0aec0; font-size: 0.78rem; }

    /* â”€â”€â”€ Preview / File List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .preview-strip { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; }
    .preview-item { position: relative; width: 80px; height: 80px; }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; }
    .rm-btn {
      position: absolute; top: -6px; right: -6px;
      width: 20px; height: 20px;
      background: #fc8181; color: #fff;
      border: 2px solid #fff; border-radius: 50%;
      font-size: 11px; font-weight: 800;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      line-height: 1;
    }
    .file-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .file-chip {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 12px;
      background: #ebf8ff; border: 1px solid #bee3f8;
      border-radius: 20px; font-size: 0.82rem; color: #2b6cb0;
    }
    .file-chip .rm { cursor: pointer; color: #fc8181; font-weight: 800; font-size: 1rem; line-height: 1; }

    /* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 10px 20px;
      border: none; border-radius: 10px;
      font-size: 0.88rem; font-weight: 700;
      cursor: pointer; transition: all 0.18s;
      white-space: nowrap;
    }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .btn-blue   { background: #4299e1; color: #fff; }
    .btn-blue:hover:not(:disabled)   { background: #3182ce; }
    .btn-green  { background: #48bb78; color: #fff; }
    .btn-green:hover:not(:disabled)  { background: #38a169; }
    .btn-dark   { background: #2d3748; color: #fff; }
    .btn-dark:hover:not(:disabled)   { background: #1a202c; }
    .btn-indigo { background: #667eea; color: #fff; }
    .btn-indigo:hover:not(:disabled) { background: #5a67d8; }
    .btn-ghost  { background: #fff; color: #4a5568; border: 1.5px solid #e2e8f0; }
    .btn-ghost:hover:not(:disabled)  { background: #f7fafc; }
    .btn-danger { background: #fff5f5; color: #e53e3e; border: 1.5px solid #fed7d7; }
    .btn-danger:hover:not(:disabled) { background: #e53e3e; color: #fff; }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; }

    .btn-extract {
      width: 100%;
      margin-top: 18px;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; border: none; border-radius: 12px;
      font-size: 1rem; font-weight: 800;
      cursor: pointer; transition: opacity 0.2s;
      letter-spacing: 0.02em;
    }
    .btn-extract:hover:not(:disabled) { opacity: 0.88; }
    .btn-extract:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€â”€ Loading Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading-bar {
      display: none;
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      margin-bottom: 18px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.07);
    }
    .loading-bar.show { display: block; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-msg { color: #667eea; font-weight: 700; font-size: 0.95rem; }
    .loading-sub { color: #a0aec0; font-size: 0.8rem; margin-top: 4px; }

    /* â”€â”€â”€ Word Table Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title { font-size: 1rem; font-weight: 700; color: #2d3748; }
    .count-badge {
      padding: 4px 14px;
      background: #ebf8ff;
      color: #2b6cb0;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .word-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .word-table th {
      background: #f7fafc;
      padding: 9px 12px;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 700;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 2px solid #e2e8f0;
    }
    .word-table td { padding: 6px 8px; border-bottom: 1px solid #f0f4f8; vertical-align: middle; }
    .word-table tr:hover td { background: #fafafa; }
    .word-table td.num { color: #cbd5e0; font-size: 0.8rem; text-align: center; width: 40px; }
    .word-table td input {
      width: 100%;
      padding: 6px 10px;
      border: 1.5px solid transparent;
      border-radius: 7px;
      font-size: 0.88rem;
      background: transparent;
      transition: all 0.15s;
    }
    .word-table td input:focus { outline: none; border-color: #4299e1; background: #fff; }

    /* â”€â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state { text-align: center; padding: 52px 20px; color: #a0aec0; }
    .empty-state .icon { font-size: 3.2rem; margin-bottom: 14px; }
    .empty-state p { font-size: 0.9rem; }

    /* â”€â”€â”€ Action Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .action-bar {
      display: grid;
      grid-template-columns: 1fr 1fr auto auto;
      gap: 10px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #f0f4f8;
    }
    @media (max-width: 600px) {
      .action-bar { grid-template-columns: 1fr 1fr; }
      .action-bar .btn-danger, .action-bar .btn-ghost { grid-column: span 1; }
    }

    /* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed;
      bottom: 24px; right: 24px;
      padding: 13px 20px;
      border-radius: 12px;
      font-size: 0.88rem; font-weight: 700;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18);
      transform: translateY(90px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
      z-index: 9999;
      max-width: 340px;
      pointer-events: none;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #48bb78; color: #fff; }
    .toast.error   { background: #fc8181; color: #fff; }
    .toast.info    { background: #4299e1; color: #fff; }
    .toast.warn    { background: #ed8936; color: #fff; }

    /* â”€â”€â”€ HWP Notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notice-box {
      padding: 14px 18px;
      background: #fef3c7;
      border: 1px solid #f6e05e;
      border-radius: 10px;
      font-size: 0.83rem;
      color: #744210;
      line-height: 1.7;
    }
    .notice-box strong { color: #92400e; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER -->
<header>
  <div class="header-brand">
    <div class="header-logo">ğŸ“š</div>
    <div>
      <div class="header-title">Ailly's English Vocabook</div>
      <div class="header-sub">ì‚¬ì§„ Â· PDF Â· DOCX Â· HWPì—ì„œ ì˜ë‹¨ì–´ë¥¼ ì¶”ì¶œí•˜ì—¬ ë‹¨ì–´ì¥ / ì‹œí—˜ì¥ ìƒì„±</div>
    </div>
  </div>
  <div class="header-badge">v2.0</div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN -->
<div class="container">

  <!-- â”€â”€ Settings Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="settings-row">

    <!-- API Key -->
    <div class="card">
      <div class="card-label">ğŸ”‘ OpenAI API Key</div>
      <div class="input-row">
        <input type="password" id="apiKey" placeholder="sk-..." autocomplete="off">
        <button class="btn btn-blue" onclick="saveApiKey()">ì €ì¥</button>
      </div>
    </div>

    <!-- Template Upload -->
    <div class="card">
      <div class="card-label">ğŸ“„ ë‹¨ì–´ì¥ í…œí”Œë¦¿ (.docx)</div>
      <div class="tmpl-zone" id="tmplZone" onclick="document.getElementById('tmplInput').click()">
        <div class="tmpl-zone-icon">ğŸ“‹</div>
        <div>
          <div class="tmpl-zone-text" id="tmplLabel">ì˜ì–´ë‹¨ì–´ì¥.docx ì—…ë¡œë“œ</div>
          <div style="font-size:0.75rem;color:#a0aec0;margin-top:2px">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
        </div>
        <input type="file" id="tmplInput" accept=".docx" onchange="loadTemplate(this)">
      </div>
      <div class="guide-box">
        ë°ì´í„° í–‰ì— ë°°ì¹˜í•  í”Œë ˆì´ìŠ¤í™€ë”:<br>
        <code>{#pairs}</code> (ë°˜ë³µ ì‹œì‘) â†’
        <code>{left_english}</code> <code>{left_korean}</code>
        <code>{right_english}</code> <code>{right_korean}</code> â†’
        <code>{/pairs}</code> (ë°˜ë³µ ë)
      </div>
    </div>

  </div><!-- /settings-row -->

  <!-- â”€â”€ Input Card (Tab Widget) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="image" onclick="switchTab('image')">ğŸ“· ì‚¬ì§„</button>
      <button class="tab-btn" data-tab="pdf"   onclick="switchTab('pdf')">ğŸ“„ PDF</button>
      <button class="tab-btn" data-tab="docx"  onclick="switchTab('docx')">ğŸ“ DOC/DOCX</button>
      <button class="tab-btn" data-tab="hwp"   onclick="switchTab('hwp')">ğŸ‡°ğŸ‡· HWP</button>
    </div>

    <!-- ì‚¬ì§„ Tab -->
    <div class="tab-panel active" id="panel-image">
      <div class="drop-zone" id="dz-image" onclick="document.getElementById('imgInput').click()">
        <div class="dz-icon">ğŸ–¼ï¸</div>
        <div class="dz-text">í´ë¦­í•˜ê±°ë‚˜ ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
        <div class="dz-hint">JPG Â· PNG Â· WEBP Â· ì—¬ëŸ¬ ì¥ ë™ì‹œ ì—…ë¡œë“œ ê°€ëŠ¥</div>
        <input type="file" id="imgInput" accept="image/*" multiple onchange="handleImages(this.files)">
      </div>
      <div class="preview-strip" id="imgPreview"></div>
    </div>

    <!-- PDF Tab -->
    <div class="tab-panel" id="panel-pdf">
      <div class="drop-zone" id="dz-pdf" onclick="document.getElementById('pdfInput').click()">
        <div class="dz-icon">ğŸ“„</div>
        <div class="dz-text">í´ë¦­í•˜ê±°ë‚˜ PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
        <div class="dz-hint">.pdf Â· ì—¬ëŸ¬ íŒŒì¼ ê°€ëŠ¥</div>
        <input type="file" id="pdfInput" accept=".pdf" multiple onchange="handleFiles('pdf', this.files)">
      </div>
      <div class="file-list" id="list-pdf"></div>
    </div>

    <!-- DOCX Tab -->
    <div class="tab-panel" id="panel-docx">
      <div class="drop-zone" id="dz-docx" onclick="document.getElementById('docxInput').click()">
        <div class="dz-icon">ğŸ“</div>
        <div class="dz-text">í´ë¦­í•˜ê±°ë‚˜ Word íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
        <div class="dz-hint">.doc Â· .docx</div>
        <input type="file" id="docxInput" accept=".doc,.docx" multiple onchange="handleFiles('docx', this.files)">
      </div>
      <div class="file-list" id="list-docx"></div>
    </div>

    <!-- HWP Tab -->
    <div class="tab-panel" id="panel-hwp">
      <div class="notice-box" style="margin-bottom:16px">
        <strong>âš ï¸ HWP ì§€ì› ì•ˆë‚´</strong><br>
        â€¢ <strong>.hwpx</strong> (í•œê¸€ 2022+): í…ìŠ¤íŠ¸ ìë™ ì¶”ì¶œ ì§€ì›<br>
        â€¢ <strong>.hwp</strong> (êµ¬ë²„ì „): ì§€ì› ì œí•œ â€” HWP ë¬¸ì„œë¥¼ <strong>í™”ë©´ ìº¡ì²˜</strong>í•˜ì—¬ <strong>[ì‚¬ì§„]</strong> íƒ­ì—ì„œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.
      </div>
      <div class="drop-zone" id="dz-hwp" onclick="document.getElementById('hwpInput').click()">
        <div class="dz-icon">ğŸ‡°ğŸ‡·</div>
        <div class="dz-text">í´ë¦­í•˜ê±°ë‚˜ HWP íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
        <div class="dz-hint">.hwpx (ê¶Œì¥) Â· .hwp (ì œí•œì )</div>
        <input type="file" id="hwpInput" accept=".hwp,.hwpx" multiple onchange="handleFiles('hwp', this.files)">
      </div>
      <div class="file-list" id="list-hwp"></div>
    </div>

    <button class="btn-extract" id="btnExtract" onclick="runExtract()" disabled>
      ğŸ” ë‹¨ì–´ ì¶”ì¶œí•˜ê¸°
    </button>
  </div><!-- /input card -->

  <!-- â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="loading-bar" id="loadingBar">
    <div class="spinner"></div>
    <div class="loading-msg" id="loadingMsg">ë¶„ì„ ì¤‘...</div>
    <div class="loading-sub" id="loadingSub"></div>
  </div>

  <!-- â”€â”€ Word Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div class="section-head">
      <div class="section-title">ğŸ“ ë‹¨ì–´ ëª©ë¡</div>
      <span class="count-badge" id="wordCount">0 ë‹¨ì–´</span>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
      <div class="icon">ğŸ“–</div>
      <p>ì‚¬ì§„Â·PDFÂ·DOCXÂ·HWPì—ì„œ ë‹¨ì–´ë¥¼ ì¶”ì¶œí•´ë³´ì„¸ìš”</p>
    </div>

    <!-- Table -->
    <div id="tableWrap" style="display:none; overflow-x:auto">
      <table class="word-table">
        <thead>
          <tr>
            <th>#</th>
            <th>ì˜ì–´ ë‹¨ì–´ / í‘œí˜„</th>
            <th>í•œê¸€ ëœ»</th>
            <th style="width:60px">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="wordBody"></tbody>
      </table>
    </div>

    <!-- Table Actions -->
    <div id="tableActions" style="display:none">
      <button class="btn btn-ghost btn-sm" style="margin-top:12px" onclick="addRow()">
        + ë‹¨ì–´ ì§ì ‘ ì¶”ê°€
      </button>
    </div>

    <!-- Output Buttons -->
    <div class="action-bar" id="actionBar" style="display:none">
      <button class="btn btn-dark" style="justify-content:center" onclick="generate('vocab')">
        ğŸ“– ë‹¨ì–´ì¥ ìƒì„±
      </button>
      <button class="btn btn-indigo" style="justify-content:center" onclick="generate('test')">
        âœï¸ ì‹œí—˜ì¥ ìƒì„±
      </button>
      <button class="btn btn-ghost btn-sm" onclick="addRow()">+ ì¶”ê°€</button>
      <button class="btn btn-danger btn-sm" onclick="clearAll()">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
    </div>
  </div>

</div><!-- /container -->

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT -->
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LAZY LIBRARY LOADER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Loader = {
  _cache: {},
  load(url) {
    if (this._cache[url]) return this._cache[url];
    this._cache[url] = new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = url;
      s.onload  = res;
      s.onerror = () => rej(new Error('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨: ' + url));
      document.head.appendChild(s);
    });
    return this._cache[url];
  }
};

const CDN = {
  pdfjs:    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
  mammoth:  'https://cdn.jsdelivr.net/npm/mammoth@1.7.0/mammoth.browser.min.js',
};
const PDF_WORKER = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  template: null,       // ArrayBuffer
  words:    [],         // [{english, korean}]
  images:   [],         // [{file, dataUrl}]  (sparse â€“ null on remove)
  pdfs:     [],
  docxArr:  [],
  hwpArr:   [],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
  const k = localStorage.getItem('openai_api_key');
  if (k) document.getElementById('apiKey').value = k;
  setupDrop('dz-image', 'image');
  setupDrop('dz-pdf',   'pdf');
  setupDrop('dz-docx',  'docx');
  setupDrop('dz-hwp',   'hwp');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveApiKey() {
  const k = document.getElementById('apiKey').value.trim();
  if (!k.startsWith('sk-')) { toast('ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (sk-...)', 'error'); return; }
  localStorage.setItem('openai_api_key', k);
  toast('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}
function getKey() { return document.getElementById('apiKey').value.trim(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMPLATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTemplate(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    S.template = e.target.result;
    document.getElementById('tmplZone').classList.add('loaded');
    document.getElementById('tmplLabel').textContent = 'âœ… ' + file.name;
    toast('í…œí”Œë¦¿ ë¡œë“œ ì™„ë£Œ', 'success');
  };
  reader.readAsArrayBuffer(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p =>
    p.classList.toggle('active', p.id === 'panel-' + name));

  // Lazy load heavy libs on first tab visit
  if (name === 'pdf') {
    Loader.load(CDN.pdfjs).then(() => {
      if (window.pdfjsLib && !pdfjsLib.GlobalWorkerOptions.workerSrc)
        pdfjsLib.GlobalWorkerOptions.workerSrc = PDF_WORKER;
    }).catch(() => {});
  }
  if (name === 'docx') {
    Loader.load(CDN.mammoth).catch(() => {});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupDrop(zoneId, type) {
  const el = document.getElementById(zoneId);
  el.addEventListener('dragover',  e => { e.preventDefault(); el.classList.add('over'); });
  el.addEventListener('dragleave', () => el.classList.remove('over'));
  el.addEventListener('drop', e => {
    e.preventDefault();
    el.classList.remove('over');
    if (type === 'image') handleImages(e.dataTransfer.files);
    else handleFiles(type, e.dataTransfer.files);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleImages(files) {
  for (const f of files) {
    if (!f.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = e => {
      const idx = S.images.length;
      S.images.push({ file: f, dataUrl: e.target.result });
      const strip = document.getElementById('imgPreview');
      const div   = document.createElement('div');
      div.className   = 'preview-item';
      div.dataset.idx = idx;
      div.innerHTML   = `
        <img src="${e.target.result}" alt="">
        <button class="rm-btn" onclick="removeImage(${idx})">Ã—</button>`;
      strip.appendChild(div);
      syncExtractBtn();
    };
    reader.readAsDataURL(f);
  }
}

function removeImage(idx) {
  S.images[idx] = null;
  document.querySelector(`.preview-item[data-idx="${idx}"]`)?.remove();
  syncExtractBtn();
}

function handleFiles(type, files) {
  const arr      = { pdf: S.pdfs, docx: S.docxArr, hwp: S.hwpArr }[type];
  const listId   = `list-${type}`;
  for (const f of files) {
    const idx = arr.length;
    arr.push(f);
    const chip = document.createElement('span');
    chip.className   = 'file-chip';
    chip.dataset.idx = idx;
    chip.dataset.type= type;
    chip.innerHTML   = `<span>ğŸ“„ ${esc(f.name)}</span>
      <span class="rm" onclick="removeFile('${type}',${idx},this)">Ã—</span>`;
    document.getElementById(listId).appendChild(chip);
  }
  syncExtractBtn();
}

function removeFile(type, idx, el) {
  const arr = { pdf: S.pdfs, docx: S.docxArr, hwp: S.hwpArr }[type];
  arr[idx] = null;
  el.closest('.file-chip').remove();
  syncExtractBtn();
}

function syncExtractBtn() {
  const has = S.images.some(Boolean)
           || S.pdfs.some(Boolean)
           || S.docxArr.some(Boolean)
           || S.hwpArr.some(Boolean);
  document.getElementById('btnExtract').disabled = !has;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN EXTRACT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runExtract() {
  const key = getKey();
  if (!key.startsWith('sk-')) { toast('OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }

  setLoading(true, 'AIê°€ ë‹¨ì–´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...');
  let added = 0;

  // â”€â”€ Images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const imgs = S.images.filter(Boolean);
  for (let i = 0; i < imgs.length; i++) {
    setLoading(true, `ì‚¬ì§„ ë¶„ì„ ì¤‘...`, `${i+1} / ${imgs.length}`);
    try {
      const ws = await extractVision(imgs[i].dataUrl, imgs[i].file.type, key);
      S.words.push(...ws); added += ws.length;
    } catch (e) { toast('ì‚¬ì§„ ì˜¤ë¥˜: ' + e.message, 'error'); }
  }

  // â”€â”€ PDFs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const pdfs = S.pdfs.filter(Boolean);
  for (let i = 0; i < pdfs.length; i++) {
    setLoading(true, `PDF ë¶„ì„ ì¤‘...`, `${i+1} / ${pdfs.length}`);
    try {
      await Loader.load(CDN.pdfjs);
      pdfjsLib.GlobalWorkerOptions.workerSrc = PDF_WORKER;
      const text = await parsePdf(pdfs[i]);
      const ws   = await extractText(text, key);
      S.words.push(...ws); added += ws.length;
    } catch (e) { toast('PDF ì˜¤ë¥˜: ' + e.message, 'error'); }
  }

  // â”€â”€ DOCX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const docxFiles = S.docxArr.filter(Boolean);
  for (let i = 0; i < docxFiles.length; i++) {
    setLoading(true, `DOCX ë¶„ì„ ì¤‘...`, `${i+1} / ${docxFiles.length}`);
    try {
      await Loader.load(CDN.mammoth);
      const text = await parseDocx(docxFiles[i]);
      const ws   = await extractText(text, key);
      S.words.push(...ws); added += ws.length;
    } catch (e) { toast('DOCX ì˜¤ë¥˜: ' + e.message, 'error'); }
  }

  // â”€â”€ HWP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const hwpFiles = S.hwpArr.filter(Boolean);
  for (let i = 0; i < hwpFiles.length; i++) {
    setLoading(true, `HWP ë¶„ì„ ì¤‘...`, `${i+1} / ${hwpFiles.length}`);
    try {
      const text = await parseHwp(hwpFiles[i]);
      const ws   = await extractText(text, key);
      S.words.push(...ws); added += ws.length;
    } catch (e) { toast('HWP ì˜¤ë¥˜: ' + e.message, 'error'); }
  }

  // â”€â”€ Reset pending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  S.images  = []; S.pdfs    = [];
  S.docxArr = []; S.hwpArr  = [];
  ['imgPreview','list-pdf','list-docx','list-hwp'].forEach(id => {
    document.getElementById(id).innerHTML = '';
  });

  setLoading(false);
  renderTable();
  if (added > 0) toast(`${added}ê°œ ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰`, 'success');
  else           toast('ì¶”ì¶œëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤', 'warn');
  syncExtractBtn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXTRACTION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GPT_PROMPT_VISION = `ì´ ì´ë¯¸ì§€ì—ì„œ ì˜ì–´ ë‹¨ì–´/í‘œí˜„ê³¼ í•œê¸€ ëœ» ìŒì„ ëª¨ë‘ ì°¾ì•„ JSON ë°°ì—´ë¡œë§Œ ë°˜í™˜í•´ì¤˜.
í˜•ì‹: [{"english":"ë‹¨ì–´","korean":"í•œê¸€ ëœ»"}]
- í’ˆì‚¬ í‘œê¸°(ëª…, ë™, í˜•, ë¶€ ë“±)ê°€ ìˆìœ¼ë©´ í•œê¸€ ëœ»ì— í¬í•¨ (ì˜ˆ: "ëª…) ê¸°ì–µë ¥")
- ì˜ì–´ì™€ í•œê¸€ì´ í•¨ê»˜ ìˆëŠ” í•­ëª©ë§Œ ì¶”ì¶œ, ì¤‘ë³µ ì œê±°
- JSON ë°°ì—´ë§Œ ë°˜í™˜ (ì„¤ëª… ì—†ì´), ì—†ìœ¼ë©´ []`;

const GPT_PROMPT_TEXT = (text) =>
`ë‹¤ìŒ í…ìŠ¤íŠ¸ì—ì„œ ì˜ì–´ ë‹¨ì–´/í‘œí˜„ê³¼ í•œê¸€ ëœ» ìŒì„ ëª¨ë‘ ì°¾ì•„ JSON ë°°ì—´ë¡œë§Œ ë°˜í™˜í•´ì¤˜.
í˜•ì‹: [{"english":"ë‹¨ì–´","korean":"í•œê¸€ ëœ»"}]
- í’ˆì‚¬ í‘œê¸°ê°€ ìˆìœ¼ë©´ í•œê¸€ ëœ»ì— í¬í•¨, ì¤‘ë³µ ì œê±°
- JSON ë°°ì—´ë§Œ ë°˜í™˜, ì—†ìœ¼ë©´ []
í…ìŠ¤íŠ¸:
${text.slice(0, 9000)}`;

async function extractVision(dataUrl, mimeType, key) {
  const base64 = dataUrl.split(',')[1];
  const mime   = mimeType || 'image/jpeg';
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [{
        role: 'user',
        content: [
          { type: 'text', text: GPT_PROMPT_VISION },
          { type: 'image_url',
            image_url: { url: `data:${mime};base64,${base64}`, detail: 'high' } }
        ]
      }],
      max_tokens: 4096
    })
  });
  if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || `HTTP ${res.status}`); }
  return parseGptResponse(await res.json());
}

async function extractText(text, key) {
  if (!text.trim()) return [];
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: GPT_PROMPT_TEXT(text) }],
      max_tokens: 4096
    })
  });
  if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || `HTTP ${res.status}`); }
  return parseGptResponse(await res.json());
}

function parseGptResponse(data) {
  const raw = data.choices?.[0]?.message?.content?.trim() || '';
  const m = raw.match(/\[[\s\S]*\]/);
  if (!m) return [];
  try {
    return JSON.parse(m[0]).filter(w => w.english && w.korean);
  } catch { return []; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function parsePdf(file) {
  if (!window.pdfjsLib) throw new Error('pdf.js ë¡œë“œ ì‹¤íŒ¨');
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  let out = '';
  for (let p = 1; p <= pdf.numPages; p++) {
    const page    = await pdf.getPage(p);
    const content = await page.getTextContent();
    out += content.items.map(i => i.str).join(' ') + '\n';
  }
  return out;
}

async function parseDocx(file) {
  if (!window.mammoth) throw new Error('mammoth.js ë¡œë“œ ì‹¤íŒ¨');
  const buf = await file.arrayBuffer();
  const res = await mammoth.extractRawText({ arrayBuffer: buf });
  return res.value;
}

async function parseHwp(file) {
  const name = file.name.toLowerCase();
  if (name.endsWith('.hwpx')) {
    // hwpx = ZIP ê¸°ë°˜, XML ì§ì ‘ íŒŒì‹±
    try {
      const buf = await file.arrayBuffer();
      const zip = new PizZip(buf);
      let text = '';
      Object.keys(zip.files).forEach(fname => {
        if (/section\d*\.xml$/i.test(fname)) {
          const xml = zip.files[fname].asText();
          (xml.match(/<hp:t[^>]*>([^<]*)<\/hp:t>/g) || []).forEach(m => {
            const t = m.replace(/<[^>]+>/g, '').trim();
            if (t) text += t + ' ';
          });
          text += '\n';
        }
      });
      if (!text.trim()) throw new Error('í…ìŠ¤íŠ¸ ì¶”ì¶œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
      return text;
    } catch (e) {
      throw new Error('HWPX íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
    }
  } else {
    throw new Error('.hwp í˜•ì‹ì€ ì§ì ‘ ì§€ì›ì´ ì–´ë µìŠµë‹ˆë‹¤.\ní™”ë©´ì„ ìº¡ì²˜í•˜ì—¬ [ì‚¬ì§„] íƒ­ì—ì„œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORD TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const body = document.getElementById('wordBody');
  body.innerHTML = '';
  S.words.forEach((w, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="num">${i + 1}</td>
      <td><input type="text" value="${esc(w.english)}"
          onchange="S.words[${i}].english=this.value" placeholder="ì˜ì–´ ë‹¨ì–´"></td>
      <td><input type="text" value="${esc(w.korean)}"
          onchange="S.words[${i}].korean=this.value" placeholder="í•œê¸€ ëœ»"></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteRow(${i})">ì‚­ì œ</button></td>`;
    body.appendChild(tr);
  });
  const has = S.words.length > 0;
  document.getElementById('emptyState').style.display    = has ? 'none'  : 'block';
  document.getElementById('tableWrap').style.display     = has ? 'block' : 'none';
  document.getElementById('tableActions').style.display  = has ? 'block' : 'none';
  document.getElementById('actionBar').style.display     = has ? 'grid'  : 'none';
  document.getElementById('wordCount').textContent = `${S.words.length} ë‹¨ì–´`;
  syncExtractBtn();
}

function deleteRow(idx) { S.words.splice(idx, 1); renderTable(); }

function addRow() {
  S.words.push({ english: '', korean: '' });
  renderTable();
  const rows = document.querySelectorAll('#wordBody tr');
  rows[rows.length - 1]?.querySelector('input')?.focus();
}

function clearAll() {
  if (!confirm('ë‹¨ì–´ ëª©ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
  S.words = []; renderTable();
  toast('ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENT GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generate(mode) {
  if (!S.template) { toast('ë¨¼ì € í…œí”Œë¦¿ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'error'); return; }
  const valid = S.words.filter(w => w.english || w.korean);
  if (!valid.length) { toast('ë‹¨ì–´ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤', 'error'); return; }

  setLoading(true, mode === 'vocab' ? 'ë‹¨ì–´ì¥ ìƒì„± ì¤‘...' : 'ì‹œí—˜ì¥ ìƒì„± ì¤‘...');
  try {
    const pairs = buildPairs(valid, mode);
    const blob  = await fillTemplate(S.template, { pairs });
    const label = mode === 'vocab' ? 'ì˜ì–´ë‹¨ì–´ì¥' : 'ì˜ì–´ë‹¨ì–´ì‹œí—˜ì¥';
    downloadBlob(blob, `${label}_${today()}.docx`);
    toast(`${label} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ âœ…`, 'success');
  } catch (e) {
    console.error(e);
    toast('ìƒì„± ì‹¤íŒ¨: ' + e.message, 'error');
  } finally {
    setLoading(false);
  }
}

function buildPairs(words, mode) {
  const pairs = [];
  for (let i = 0; i < words.length; i += 2) {
    const L = words[i]     || { english: '', korean: '' };
    const R = words[i + 1] || { english: '', korean: '' };
    if (mode === 'vocab') {
      pairs.push({
        left_english:  L.english,
        left_korean:   L.korean,
        right_english: R.english,
        right_korean:  R.korean,
      });
    } else { // ì‹œí—˜ì¥
      pairs.push({
        left_english:  '',           // ì˜ì–´ ì œê±° â†’ ë¹ˆì¹¸ (í•œê¸€ ë³´ê³  ì“°ê¸°)
        left_korean:   L.korean,     // í•œê¸€ ìœ ì§€
        right_english: R.english,    // ì˜ì–´ ìœ ì§€ (ì˜ì–´ ë³´ê³  í•œê¸€ ì“°ê¸°)
        right_korean:  '',           // í•œê¸€ ì œê±° â†’ ë¹ˆì¹¸
      });
    }
  }
  return pairs;
}

async function fillTemplate(buffer, data) {
  // Clone buffer (PizZip consumes it)
  const clone = buffer.slice(0);
  const zip   = new PizZip(clone);
  const doc   = new Docxtemplater(zip, {
    paragraphLoop: true,
    linebreaks:    true,
    nullGetter:    () => '',   // undefined ë³€ìˆ˜ â†’ ë¹ˆ ë¬¸ìì—´
  });
  doc.setData(data);
  doc.render();

  // Post-process: adjust font sizes for long text
  const outZip = doc.getZip();
  const xmlKey = 'word/document.xml';
  if (outZip.files[xmlKey]) {
    outZip.file(xmlKey, adjustFontSizes(outZip.files[xmlKey].asText()));
  }

  return outZip.generate({
    type:     'blob',
    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FONT SIZE AUTO-ADJUSTMENT
// ì…€ í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë”°ë¼ í°íŠ¸ í¬ê¸°ë¥¼ ìë™ìœ¼ë¡œ ì¤„ì—¬ í•œ ì¤„ ìœ ì§€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adjustFontSizes(xml) {
  try {
    // ê° <w:tc> ì…€ ë¸”ë¡ì„ ìˆœíšŒ
    return xml.replace(/<w:tc[ >][\s\S]*?<\/w:tc>/g, cellXml => {
      // ì…€ ì „ì²´ í…ìŠ¤íŠ¸ ì¶”ì¶œ
      const totalText = (cellXml.match(/<w:t[^>]*>[\s\S]*?<\/w:t>/g) || [])
        .map(t => t.replace(/<[^>]*>/g, ''))
        .join('');

      if (totalText.length <= 13) return cellXml; // ì§§ìœ¼ë©´ ê·¸ëŒ€ë¡œ

      // ê¸¸ì´ â†’ í°íŠ¸ í¬ê¸° (half-points: 20 = 10pt)
      const len  = totalText.length;
      const size = len <= 19 ? 18   // 9pt
                 : len <= 26 ? 16   // 8pt
                 : len <= 34 ? 14   // 7pt
                 :             12;  // 6pt

      return cellXml
        // ê¸°ì¡´ sz ì œê±°
        .replace(/<w:sz w:val="[^"]*"\/>/g, '')
        .replace(/<w:szCs w:val="[^"]*"\/>/g, '')
        // <w:rPr> ë’¤ì— ìƒˆ í¬ê¸° ì‚½ì…
        .replace(/<w:rPr>/g,
          `<w:rPr><w:sz w:val="${size}"/><w:szCs w:val="${size}"/>`);
    });
  } catch (e) {
    console.warn('Font size adjustment skipped:', e);
    return xml;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLoading(show, msg = '', sub = '') {
  const bar = document.getElementById('loadingBar');
  bar.classList.toggle('show', show);
  if (msg) document.getElementById('loadingMsg').textContent = msg;
  document.getElementById('loadingSub').textContent = sub;
  document.getElementById('btnExtract').disabled = show;
}

let toastTimer;
function toast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3600);
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a   = Object.assign(document.createElement('a'), { href: url, download: filename });
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

function today() { return new Date().toISOString().slice(0, 10); }

function esc(str) {
  return (str || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
</script>
</body>
</html>
