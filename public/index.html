<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aelim Son's English Vocabook</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="/lib/pizzip.js"></script>
  <script src="/lib/docxtemplater.js"></script>
  <style>
    /* â”€â”€ Reset â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* â”€â”€ Tokens â”€â”€ */
    :root {
      --bg:       #f4f6fb;
      --surface:  #ffffff;
      --border:   #e8ecf4;
      --text-1:   #0d1226;
      --text-2:   #5a6380;
      --text-3:   #9ba3bc;
      --accent:   #5b5ef4;
      --accent-2: #8b5cf6;
      --success:  #22c55e;
      --danger:   #ef4444;
      --warn:     #f59e0b;
      --radius:   16px;
      --shadow-sm: 0 1px 4px rgba(13,18,38,.06), 0 4px 16px rgba(13,18,38,.04);
      --shadow-md: 0 4px 24px rgba(13,18,38,.09);
    }

    /* â”€â”€ Base â”€â”€ */
    html { font-size: 16px; }
    body {
      font-family: 'Plus Jakarta Sans', 'Malgun Gothic', sans-serif;
      background: var(--bg);
      color: var(--text-1);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      position: sticky; top: 0; z-index: 200;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--border);
      height: 62px;
      display: flex; align-items: center;
      padding: 0 32px;
      gap: 16px;
    }
    .header-mark {
      width: 36px; height: 36px; flex-shrink: 0;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; box-shadow: 0 4px 12px rgba(91,94,244,.35);
    }
    .header-name {
      font-size: 1rem; font-weight: 800; color: var(--text-1);
      letter-spacing: -.3px;
    }
    .header-sub {
      font-size: 0.72rem; color: var(--text-3); margin-top: 1px;
    }
    .header-spacer { flex: 1; }
    .header-pill {
      font-size: 0.72rem; font-weight: 700;
      padding: 4px 11px; border-radius: 20px;
      background: linear-gradient(135deg, #ede9fe, #dbeafe);
      color: var(--accent); letter-spacing: .04em;
    }

    /* â”€â”€ Layout â”€â”€ */
    .page { max-width: 960px; margin: 0 auto; padding: 24px 20px 80px; }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
    }
    .card-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
    }
    .card-icon {
      width: 34px; height: 34px; border-radius: 9px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
    }
    .card-icon.violet { background: #ede9fe; }
    .card-icon.blue   { background: #dbeafe; }
    .card-icon.green  { background: #dcfce7; }
    .card-title { font-size: 0.95rem; font-weight: 700; color: var(--text-1); }
    .card-label {
      font-size: 0.72rem; font-weight: 700; color: var(--text-3);
      text-transform: uppercase; letter-spacing: .08em;
    }

    /* â”€â”€ Segment Tabs â”€â”€ */
    .seg-tabs {
      display: inline-flex; gap: 4px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 12px; padding: 4px; margin-bottom: 20px;
    }
    .seg-btn {
      padding: 8px 18px; border: none; border-radius: 9px;
      font-family: inherit; font-size: 0.83rem; font-weight: 600;
      color: var(--text-2); cursor: pointer; background: transparent;
      transition: all .18s; white-space: nowrap;
    }
    .seg-btn:hover { color: var(--text-1); }
    .seg-btn.active {
      background: var(--surface); color: var(--accent);
      box-shadow: 0 1px 6px rgba(0,0,0,.1);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Drop Zone â”€â”€ */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 14px; padding: 44px 24px;
      text-align: center; cursor: pointer;
      transition: all .2s; background: #fafafa;
      position: relative; overflow: hidden;
    }
    .drop-zone:hover, .drop-zone.over {
      border-color: var(--accent); background: #f6f6ff;
    }
    .drop-zone input[type="file"] { display: none; }
    .dz-icon {
      width: 52px; height: 52px; border-radius: 14px; margin: 0 auto 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
      background: linear-gradient(135deg, #ede9fe, #dbeafe);
      transition: transform .2s;
    }
    .drop-zone:hover .dz-icon { transform: scale(1.08); }
    .dz-text {
      font-size: 0.9rem; font-weight: 600; color: var(--text-1); margin-bottom: 4px;
    }
    .dz-hint { font-size: 0.78rem; color: var(--text-3); }

    /* â”€â”€ Preview â”€â”€ */
    .preview-strip { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }
    .preview-item  {
      position: relative; width: 76px; height: 76px;
      border-radius: 10px; overflow: visible;
    }
    .preview-item img {
      width: 100%; height: 100%; object-fit: cover;
      border-radius: 10px; border: 2px solid var(--border);
    }
    .rm-btn {
      position: absolute; top: -7px; right: -7px;
      width: 22px; height: 22px;
      background: var(--danger); color: #fff;
      border: 2.5px solid var(--surface); border-radius: 50%;
      font-size: 10px; font-weight: 800; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      line-height: 1; transition: transform .15s;
    }
    .rm-btn:hover { transform: scale(1.15); }

    .file-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; }
    .file-chip {
      display: inline-flex; align-items: center; gap: 7px;
      padding: 6px 12px; border-radius: 8px;
      background: #f1f0ff; border: 1px solid #ddd9ff;
      font-size: 0.8rem; font-weight: 600; color: var(--accent);
    }
    .file-chip .rm {
      cursor: pointer; color: var(--danger); font-weight: 800;
      font-size: 0.95rem; line-height: 1; transition: transform .15s;
    }
    .file-chip .rm:hover { transform: scale(1.2); }

    /* â”€â”€ Notice â”€â”€ */
    .notice {
      padding: 14px 16px; border-radius: 12px;
      background: #fffbeb; border: 1px solid #fde68a;
      font-size: 0.82rem; color: #78350f; line-height: 1.7; margin-bottom: 14px;
    }
    .notice strong { color: #92400e; }

    /* â”€â”€ Extract Button â”€â”€ */
    .btn-extract {
      width: 100%; margin-top: 20px;
      padding: 15px; border: none; border-radius: 12px;
      font-family: inherit; font-size: 0.95rem; font-weight: 700;
      cursor: pointer; transition: all .2s; position: relative; overflow: hidden;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      color: #fff; letter-spacing: -.1px;
      box-shadow: 0 4px 16px rgba(91,94,244,.35);
    }
    .btn-extract:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 22px rgba(91,94,244,.45);
    }
    .btn-extract:active:not(:disabled) { transform: translateY(0); }
    .btn-extract:disabled {
      opacity: .4; cursor: not-allowed; box-shadow: none;
    }

    /* â”€â”€ Loading â”€â”€ */
    .loading-wrap {
      display: none; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 36px 24px; text-align: center;
      margin-bottom: 16px; box-shadow: var(--shadow-sm);
    }
    .loading-wrap.show { display: block; }
    .spinner-ring {
      width: 44px; height: 44px; margin: 0 auto 18px;
      border-radius: 50%;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      animation: spin .75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-msg { font-size: 0.95rem; font-weight: 700; color: var(--accent); }
    .loading-sub { font-size: 0.8rem; color: var(--text-3); margin-top: 5px; }

    /* â”€â”€ Word Table â”€â”€ */
    .section-head {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 18px;
    }
    .section-title { font-size: 1rem; font-weight: 700; color: var(--text-1); }
    .count-badge {
      padding: 4px 14px; border-radius: 20px;
      background: linear-gradient(135deg, #ede9fe, #dbeafe);
      color: var(--accent); font-size: 0.78rem; font-weight: 700;
    }
    .word-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
    .word-table thead tr {
      background: var(--bg); border-radius: 10px;
    }
    .word-table th {
      padding: 10px 14px; text-align: left;
      font-size: 0.72rem; font-weight: 700; color: var(--text-3);
      text-transform: uppercase; letter-spacing: .07em;
      border-bottom: 1px solid var(--border);
    }
    .word-table tbody tr { transition: background .12s; }
    .word-table tbody tr:hover { background: #f8f8ff; }
    .word-table td {
      padding: 5px 8px; border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .word-table td.num {
      color: var(--text-3); font-size: 0.78rem; text-align: center; width: 42px;
      font-variant-numeric: tabular-nums;
    }
    .word-table td input {
      width: 100%; padding: 7px 11px;
      border: 1.5px solid transparent; border-radius: 8px;
      font-family: inherit; font-size: 0.87rem;
      background: transparent; transition: all .15s; color: var(--text-1);
    }
    .word-table td input:focus {
      outline: none; border-color: var(--accent);
      background: #f6f6ff; box-shadow: 0 0 0 3px rgba(91,94,244,.1);
    }
    .word-table td input::placeholder { color: var(--text-3); }
    .word-table td.del-cell { width: 52px; text-align: center; }
    .del-btn {
      width: 28px; height: 28px; border: none; border-radius: 7px;
      background: transparent; color: var(--text-3); cursor: pointer;
      font-size: 1.1rem; display: inline-flex; align-items: center; justify-content: center;
      transition: all .15s;
    }
    .del-btn:hover { background: #fee2e2; color: var(--danger); }

    /* â”€â”€ Empty State â”€â”€ */
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-3);
    }
    .empty-icon {
      width: 72px; height: 72px; border-radius: 20px; margin: 0 auto 18px;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem;
      background: linear-gradient(135deg, #f1f0ff, #ede9fe);
    }
    .empty-state p { font-size: 0.9rem; line-height: 1.7; }

    /* â”€â”€ Action Bar â”€â”€ */
    .action-bar {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 10px; margin-top: 22px; padding-top: 18px;
      border-top: 1px solid var(--border);
    }
    .action-bar-row2 {
      display: flex; gap: 8px; margin-top: 8px;
    }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 7px;
      padding: 11px 20px; border: none; border-radius: 10px;
      font-family: inherit; font-size: 0.87rem; font-weight: 700;
      cursor: pointer; transition: all .18s; white-space: nowrap; letter-spacing: -.1px;
    }
    .btn:disabled { opacity: .4; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff; box-shadow: 0 3px 12px rgba(91,94,244,.3);
    }
    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 5px 18px rgba(91,94,244,.4); transform: translateY(-1px);
    }

    .btn-dark {
      background: var(--text-1); color: #fff;
      box-shadow: 0 2px 8px rgba(13,18,38,.18);
    }
    .btn-dark:hover:not(:disabled) { background: #1e2640; transform: translateY(-1px); }

    .btn-outline {
      background: var(--surface); color: var(--text-2);
      border: 1.5px solid var(--border);
    }
    .btn-outline:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); background: #f6f6ff; }

    .btn-danger {
      background: #fff1f1; color: var(--danger); border: 1.5px solid #fecaca;
    }
    .btn-danger:hover:not(:disabled) { background: var(--danger); color: #fff; }

    .btn-sm { padding: 7px 14px; font-size: 0.8rem; border-radius: 8px; }
    .btn-full { width: 100%; }

    /* â”€â”€ Toast â”€â”€ */
    .toast {
      position: fixed; bottom: 28px; right: 28px;
      padding: 13px 20px; border-radius: 12px;
      font-family: inherit; font-size: 0.87rem; font-weight: 600;
      box-shadow: 0 8px 30px rgba(0,0,0,.18);
      transform: translateY(100px) scale(.95); opacity: 0;
      transition: all .3s cubic-bezier(.34,1.56,.64,1);
      z-index: 9999; max-width: 360px; pointer-events: none;
      display: flex; align-items: center; gap: 9px;
    }
    .toast.show { transform: translateY(0) scale(1); opacity: 1; }
    .toast.success { background: #166534; color: #fff; }
    .toast.error   { background: #991b1b; color: #fff; }
    .toast.info    { background: var(--accent); color: #fff; }
    .toast.warn    { background: #92400e; color: #fff; }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 640px) {
      .hero-title { font-size: 1.8rem; }
      .header { padding: 0 16px; }
      .page { padding: 20px 14px 60px; }
      .seg-tabs { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-mark">ğŸ“š</div>
  <div>
    <div class="header-name">Aelim Son's English Vocabook</div>
    <div class="header-sub">AI ì˜ë‹¨ì–´ ì¶”ì¶œ &amp; ë‹¨ì–´ì¥ ìƒì„±ê¸°</div>
  </div>
  <div class="header-spacer"></div>
  <div class="header-pill">v2.0</div>
</header>

<div class="page">

  <!-- UPLOAD CARD -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon violet">ğŸ“‚</div>
      <div>
        <div class="card-title">íŒŒì¼ ì—…ë¡œë“œ</div>
        <div class="card-label">ì§€ì› í˜•ì‹: ì‚¬ì§„ Â· PDF</div>
      </div>
    </div>

    <div class="seg-tabs">
      <button class="seg-btn active" data-tab="image" onclick="switchTab('image')">ğŸ“· ì‚¬ì§„</button>
      <button class="seg-btn" data-tab="pdf"   onclick="switchTab('pdf')">ğŸ“„ PDF</button>
    </div>

    <!-- ì‚¬ì§„ -->
    <div class="tab-panel active" id="panel-image">
      <div class="drop-zone" id="dz-image" onclick="document.getElementById('imgInput').click()">
        <div class="dz-icon">ğŸ–¼ï¸</div>
        <div class="dz-text">í´ë¦­í•˜ê±°ë‚˜ ì‚¬ì§„ì„ ì—¬ê¸°ì— ë“œë˜ê·¸</div>
        <div class="dz-hint">JPG Â· PNG Â· WEBP Â· ì—¬ëŸ¬ ì¥ ë™ì‹œ ê°€ëŠ¥</div>
        <input type="file" id="imgInput" accept="image/*" multiple onchange="handleImages(this.files)">
      </div>
      <div class="preview-strip" id="imgPreview"></div>
    </div>

    <!-- PDF -->
    <div class="tab-panel" id="panel-pdf">
      <div class="drop-zone" id="dz-pdf" onclick="document.getElementById('pdfInput').click()">
        <div class="dz-icon">ğŸ“„</div>
        <div class="dz-text">í´ë¦­í•˜ê±°ë‚˜ PDF íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸</div>
        <div class="dz-hint">.pdf Â· ì—¬ëŸ¬ íŒŒì¼ ê°€ëŠ¥</div>
        <input type="file" id="pdfInput" accept=".pdf" multiple onchange="handleFiles('pdf', this.files)">
      </div>
      <div class="file-list" id="list-pdf"></div>
    </div>

    <button class="btn-extract" id="btnExtract" onclick="runExtract()" disabled>
      âœ¦ AIë¡œ ë‹¨ì–´ ì¶”ì¶œí•˜ê¸°
    </button>
  </div>

  <!-- LOADING -->
  <div class="loading-wrap" id="loadingBar">
    <div class="spinner-ring"></div>
    <div class="loading-msg" id="loadingMsg">ë¶„ì„ ì¤‘...</div>
    <div class="loading-sub" id="loadingSub"></div>
  </div>

  <!-- WORD TABLE -->
  <div class="card">
    <div class="section-head">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="card-icon green">ğŸ“‹</div>
        <div class="section-title">ë‹¨ì–´ ëª©ë¡</div>
      </div>
      <span class="count-badge" id="wordCount">0 ë‹¨ì–´</span>
    </div>

    <div class="empty-state" id="emptyState">
      <div class="empty-icon">ğŸ“–</div>
      <p>ìœ„ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´<br>AIê°€ ì˜ë‹¨ì–´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤</p>
    </div>

    <div id="tableWrap" style="display:none; overflow-x:auto">
      <table class="word-table">
        <thead>
          <tr>
            <th>#</th>
            <th>ì˜ì–´ ë‹¨ì–´ / í‘œí˜„</th>
            <th>í•œê¸€ ëœ»</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="wordBody"></tbody>
      </table>
    </div>

    <div id="tableActions" style="display:none; margin-top:12px">
      <button class="btn btn-outline btn-sm" onclick="addRow()">+ ë‹¨ì–´ ì§ì ‘ ì¶”ê°€</button>
    </div>

    <div class="action-bar" id="actionBar" style="display:none">
      <button class="btn btn-dark btn-full" onclick="generate('vocab')">ğŸ“– ë‹¨ì–´ì¥ ìƒì„±</button>
      <button class="btn btn-primary btn-full" onclick="generate('test')">âœï¸ ì‹œí—˜ì¥ ìƒì„±</button>
    </div>
    <div class="action-bar-row2" id="actionBar2" style="display:none">
      <button class="btn btn-outline btn-sm" onclick="addRow()">+ ì¶”ê°€</button>
      <button class="btn btn-danger btn-sm" onclick="clearAll()">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

// â”€â”€ LAZY LOADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Loader = {
  _cache: {},
  load(url) {
    if (this._cache[url]) return this._cache[url];
    this._cache[url] = new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = url; s.onload = res;
      s.onerror = () => rej(new Error('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨: ' + url));
      document.head.appendChild(s);
    });
    return this._cache[url];
  }
};
const CDN = {
  pdfjs: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
};
const PDF_WORKER = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  template: null,
  words: [], images: [], pdfs: [],
};

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  setupDrop('dz-image', 'image');
  setupDrop('dz-pdf',   'pdf');
  await autoLoadTemplate();
})();

// â”€â”€ TEMPLATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function autoLoadTemplate() {
  try {
    const res = await fetch('/ì˜ì–´ë‹¨ì–´ì¥.docx');
    if (!res.ok) throw new Error('íŒŒì¼ ì—†ìŒ');
    S.template = await res.arrayBuffer();
  } catch (e) {
    toast('í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
  }
}

// â”€â”€ TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.seg-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p =>
    p.classList.toggle('active', p.id === 'panel-' + name));
  if (name === 'pdf') {
    Loader.load(CDN.pdfjs).then(() => {
      if (window.pdfjsLib && !pdfjsLib.GlobalWorkerOptions.workerSrc)
        pdfjsLib.GlobalWorkerOptions.workerSrc = PDF_WORKER;
    }).catch(() => {});
  }
}

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDrop(zoneId, type) {
  const el = document.getElementById(zoneId);
  el.addEventListener('dragover',  e => { e.preventDefault(); el.classList.add('over'); });
  el.addEventListener('dragleave', () => el.classList.remove('over'));
  el.addEventListener('drop', e => {
    e.preventDefault(); el.classList.remove('over');
    if (type === 'image') handleImages(e.dataTransfer.files);
    else handleFiles(type, e.dataTransfer.files);
  });
}

// â”€â”€ FILE HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleImages(files) {
  for (const f of files) {
    if (!f.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = e => {
      const idx = S.images.length;
      S.images.push({ file: f, dataUrl: e.target.result });
      const div = document.createElement('div');
      div.className = 'preview-item'; div.dataset.idx = idx;
      div.innerHTML = `<img src="${e.target.result}" alt="">
        <button class="rm-btn" onclick="removeImage(${idx})">Ã—</button>`;
      document.getElementById('imgPreview').appendChild(div);
      syncExtractBtn();
    };
    reader.readAsDataURL(f);
  }
}

function removeImage(idx) {
  S.images[idx] = null;
  document.querySelector(`.preview-item[data-idx="${idx}"]`)?.remove();
  syncExtractBtn();
}

function handleFiles(type, files) {
  const arr = { pdf: S.pdfs }[type];
  for (const f of files) {
    const idx = arr.length; arr.push(f);
    const chip = document.createElement('span');
    chip.className = 'file-chip'; chip.dataset.idx = idx;
    chip.innerHTML = `<span>ğŸ“„ ${esc(f.name)}</span>
      <span class="rm" onclick="removeFile('${type}',${idx},this)">Ã—</span>`;
    document.getElementById(`list-${type}`).appendChild(chip);
  }
  syncExtractBtn();
}

function removeFile(type, idx, el) {
  ({ pdf: S.pdfs }[type])[idx] = null;
  el.closest('.file-chip').remove();
  syncExtractBtn();
}

function syncExtractBtn() {
  const has = S.images.some(Boolean) || S.pdfs.some(Boolean);
  document.getElementById('btnExtract').disabled = !has;
}

// â”€â”€ EXTRACT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runExtract() {
  setLoading(true, 'AIê°€ ë‹¨ì–´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...');
  let added = 0;

  const imgs = S.images.filter(Boolean);
  for (let i = 0; i < imgs.length; i++) {
    setLoading(true, `ì‚¬ì§„ ë¶„ì„ ì¤‘...`, `${i+1} / ${imgs.length}`);
    try {
      const ws = await extractVision(imgs[i].dataUrl, imgs[i].file.type);
      S.words.push(...ws); added += ws.length;
    } catch (e) { toast('ì‚¬ì§„ ì˜¤ë¥˜: ' + e.message, 'error'); }
  }

  const pdfs = S.pdfs.filter(Boolean);
  for (let i = 0; i < pdfs.length; i++) {
    setLoading(true, `PDF ë¶„ì„ ì¤‘...`, `${i+1} / ${pdfs.length}`);
    try {
      await Loader.load(CDN.pdfjs);
      pdfjsLib.GlobalWorkerOptions.workerSrc = PDF_WORKER;
      const text = await parsePdf(pdfs[i]);
      let ws = [];

      // 1ì°¨: í…ìŠ¤íŠ¸ ì²­í¬ ë‹¨ìœ„ë¡œ ì¶”ì¶œ
      if (text.trim().length >= 30) {
        const chunks = splitChunks(text, 6000);
        for (let c = 0; c < chunks.length; c++) {
          setLoading(true, `PDF í…ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...`, `${c+1} / ${chunks.length} ì²­í¬`);
          const cw = await extractText(chunks[c]);
          ws.push(...cw);
        }
      }

      // 2ì°¨: í…ìŠ¤íŠ¸ì—ì„œ ë‹¨ì–´ë¥¼ ëª» ì°¾ìœ¼ë©´ â†’ í˜ì´ì§€ ì´ë¯¸ì§€ë¡œ Vision API ì¬ì‹œë„
      if (ws.length === 0) {
        setLoading(true, `PDF ì´ë¯¸ì§€ ë³€í™˜ ì¤‘...`, `${i+1} / ${pdfs.length}`);
        const images = await pdfToImages(pdfs[i]);
        for (let p = 0; p < images.length; p++) {
          setLoading(true, `PDF í˜ì´ì§€ ë¶„ì„ ì¤‘...`, `í˜ì´ì§€ ${p+1} / ${images.length}`);
          const pw = await extractVision(images[p], 'image/png');
          ws.push(...pw);
        }
      }

      ws = dedupeWords(ws);
      S.words.push(...ws); added += ws.length;
    } catch (e) { toast('PDF ì˜¤ë¥˜: ' + e.message, 'error'); }
  }

  S.images = []; S.pdfs = [];
  ['imgPreview','list-pdf'].forEach(id =>
    document.getElementById(id).innerHTML = '');

  setLoading(false);
  renderTable();
  toast(added > 0 ? `${added}ê°œ ë‹¨ì–´ ì¶”ì¶œ ì™„ë£Œ ğŸ‰` : 'ì¶”ì¶œëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤',
        added > 0 ? 'success' : 'warn');
  syncExtractBtn();
}

// â”€â”€ GPT API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callGpt(body) {
  const res = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  if (!res.ok) {
    const e = await res.json().catch(() => ({}));
    throw new Error(e.error?.message || e.error || `HTTP ${res.status}`);
  }
  return res.json();
}

const PROMPT_VISION = `ì´ ì´ë¯¸ì§€ì—ì„œ ì˜ì–´ ë‹¨ì–´/í‘œí˜„ê³¼ í•œê¸€ ëœ» ìŒì„ ëª¨ë‘ ì°¾ì•„ JSON ë°°ì—´ë¡œë§Œ ë°˜í™˜í•´ì¤˜.
í˜•ì‹: [{"english":"ë‹¨ì–´","korean":"í•œê¸€ ëœ»"}]
- í’ˆì‚¬ í‘œê¸°(ëª…, ë™, í˜•, ë¶€ ë“±)ê°€ ìˆìœ¼ë©´ í•œê¸€ ëœ»ì— í¬í•¨ (ì˜ˆ: "ëª…) ê¸°ì–µë ¥")
- ì˜ì–´ì™€ í•œê¸€ì´ í•¨ê»˜ ìˆëŠ” í•­ëª©ë§Œ ì¶”ì¶œ, ì¤‘ë³µ ì œê±°
- JSON ë°°ì—´ë§Œ ë°˜í™˜, ì—†ìœ¼ë©´ []`;

const PROMPT_TEXT = text =>
`ë‹¤ìŒ í…ìŠ¤íŠ¸ì—ì„œ ì˜ì–´ ë‹¨ì–´/í‘œí˜„ê³¼ í•œê¸€ ëœ» ìŒì„ ëª¨ë‘ ì°¾ì•„ JSON ë°°ì—´ë¡œë§Œ ë°˜í™˜í•´ì¤˜.
í˜•ì‹: [{"english":"ë‹¨ì–´","korean":"í•œê¸€ ëœ»"}]
- í’ˆì‚¬ í‘œê¸°ê°€ ìˆìœ¼ë©´ í•œê¸€ ëœ»ì— í¬í•¨, ì¤‘ë³µ ì œê±°
- JSON ë°°ì—´ë§Œ ë°˜í™˜, ì—†ìœ¼ë©´ []
í…ìŠ¤íŠ¸:
${text.slice(0, 9000)}`;

async function extractVision(dataUrl, mimeType) {
  const data = await callGpt({
    model: 'gpt-4o',
    messages: [{ role: 'user', content: [
      { type: 'text', text: PROMPT_VISION },
      { type: 'image_url', image_url: { url: dataUrl, detail: 'high' } }
    ]}],
    max_tokens: 4096,
  });
  return parseGpt(data);
}

async function extractText(text) {
  if (!text.trim()) return [];
  const data = await callGpt({
    model: 'gpt-4o',
    messages: [{ role: 'user', content: PROMPT_TEXT(text) }],
    max_tokens: 4096,
  });
  return parseGpt(data);
}

function parseGpt(data) {
  const raw = data.choices?.[0]?.message?.content?.trim() || '';
  const m = raw.match(/\[[\s\S]*\]/);
  if (!m) return [];
  try { return JSON.parse(m[0]).filter(w => w.english && w.korean); }
  catch { return []; }
}

function splitChunks(text, size) {
  const chunks = [];
  for (let i = 0; i < text.length; i += size) {
    chunks.push(text.slice(i, i + size));
  }
  return chunks;
}

function dedupeWords(words) {
  const seen = new Set();
  return words.filter(w => {
    const key = w.english.toLowerCase().trim();
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

// â”€â”€ PARSERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function parsePdf(file) {
  if (!window.pdfjsLib) throw new Error('pdf.js ë¡œë“œ ì‹¤íŒ¨');
  const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
  let out = '';
  for (let p = 1; p <= pdf.numPages; p++) {
    const c = await (await pdf.getPage(p)).getTextContent();
    out += c.items.map(i => i.str).join(' ') + '\n';
  }
  return out;
}

async function pdfToImages(file) {
  if (!window.pdfjsLib) throw new Error('pdf.js ë¡œë“œ ì‹¤íŒ¨');
  const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
  const images = [];
  for (let p = 1; p <= pdf.numPages; p++) {
    const page   = await pdf.getPage(p);
    const vp     = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement('canvas');
    canvas.width  = vp.width;
    canvas.height = vp.height;
    await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
    images.push(canvas.toDataURL('image/png'));
  }
  return images;
}

// â”€â”€ WORD TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const body = document.getElementById('wordBody');
  body.innerHTML = '';
  S.words.forEach((w, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="num">${i+1}</td>
      <td><input type="text" value="${esc(w.english)}"
          onchange="S.words[${i}].english=this.value" placeholder="ì˜ì–´ ë‹¨ì–´"></td>
      <td><input type="text" value="${esc(w.korean)}"
          onchange="S.words[${i}].korean=this.value" placeholder="í•œê¸€ ëœ»"></td>
      <td class="del-cell"><button class="del-btn" onclick="deleteRow(${i})" title="ì‚­ì œ">âœ•</button></td>`;
    body.appendChild(tr);
  });
  const has = S.words.length > 0;
  document.getElementById('emptyState').style.display    = has ? 'none'  : 'block';
  document.getElementById('tableWrap').style.display     = has ? 'block' : 'none';
  document.getElementById('tableActions').style.display  = has ? 'block' : 'none';
  document.getElementById('actionBar').style.display     = has ? 'grid'  : 'none';
  document.getElementById('actionBar2').style.display    = has ? 'flex'  : 'none';
  document.getElementById('wordCount').textContent = `${S.words.length} ë‹¨ì–´`;
  syncExtractBtn();
}

function deleteRow(idx) { S.words.splice(idx, 1); renderTable(); }

function addRow() {
  S.words.push({ english: '', korean: '' });
  renderTable();
  document.querySelectorAll('#wordBody tr:last-child input')[0]?.focus();
}

function clearAll() {
  if (!confirm('ë‹¨ì–´ ëª©ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
  S.words = []; renderTable();
  toast('ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

// â”€â”€ GENERATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generate(mode) {
  if (!S.template) { toast('í…œí”Œë¦¿ íŒŒì¼ì„ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error'); return; }
  const valid = S.words.filter(w => w.english || w.korean);
  if (!valid.length) { toast('ë‹¨ì–´ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤', 'error'); return; }

  setLoading(true, mode === 'vocab' ? 'ë‹¨ì–´ì¥ ìƒì„± ì¤‘...' : 'ì‹œí—˜ì¥ ìƒì„± ì¤‘...');
  try {
    const pairs = buildPairs(valid, mode);
    const blob  = await fillTemplate(S.template, { pairs });
    const label = mode === 'vocab' ? 'ì˜ì–´ë‹¨ì–´ì¥' : 'ì˜ì–´ë‹¨ì–´ì‹œí—˜ì¥';
    downloadBlob(blob, `${label}_${today()}.docx`);
    toast(`${label} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ âœ…`, 'success');
  } catch (e) {
    console.error('[generate]', e);
    toast('ìƒì„± ì‹¤íŒ¨', 'error');
    setTimeout(() => alert('âš ï¸ ìƒì„± ì‹¤íŒ¨\n\n' + (e.message || String(e))), 300);
  } finally {
    setLoading(false);
  }
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function buildPairs(words, mode) {
  const source = mode === 'test' ? shuffle(words) : words;
  const pairs = [];
  for (let i = 0; i < source.length; i += 2) {
    const L = source[i]     || { english: '', korean: '' };
    const R = source[i + 1] || { english: '', korean: '' };
    pairs.push(mode === 'vocab'
      ? { left_english: L.english, left_korean: L.korean,
          right_english: R.english, right_korean: R.korean }
      : { left_english: '',        left_korean: L.korean,
          right_english: R.english, right_korean: '' });
  }
  return pairs;
}

async function fillTemplate(buffer, data) {
  let zip;
  try { zip = new PizZip(buffer.slice(0)); }
  catch (e) { throw new Error('í…œí”Œë¦¿ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (' + e.message + ')'); }

  const doc = new docxtemplater(zip, {
    paragraphLoop: true, linebreaks: true, nullGetter: () => '',
  });

  try { doc.render(data); }
  catch (e) {
    if (e.properties && Array.isArray(e.properties.errors)) {
      const details = e.properties.errors
        .map(err => err.properties?.explanation || err.message || String(err)).join(' / ');
      throw new Error('í…œí”Œë¦¿ ì˜¤ë¥˜: ' + details);
    }
    throw new Error('ë Œë”ë§ ì‹¤íŒ¨: ' + (e.message || String(e)));
  }

  const outZip = doc.getZip();
  const xmlKey = 'word/document.xml';
  if (outZip.files[xmlKey])
    outZip.file(xmlKey, adjustFontSizes(outZip.files[xmlKey].asText()));

  return outZip.generate({
    type: 'blob',
    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  });
}

// â”€â”€ FONT SIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adjustFontSizes(xml) {
  try {
    return xml.replace(/<w:tc[ >][\s\S]*?<\/w:tc>/g, cellXml => {
      const text = (cellXml.match(/<w:t[^>]*>[\s\S]*?<\/w:t>/g) || [])
        .map(t => t.replace(/<[^>]*>/g, '')).join('');
      if (text.length <= 13) return cellXml;
      const size = text.length <= 19 ? 18 : text.length <= 26 ? 16
                 : text.length <= 34 ? 14 : 12;
      return cellXml
        .replace(/<w:sz w:val="[^"]*"\/>/g, '')
        .replace(/<w:szCs w:val="[^"]*"\/>/g, '')
        .replace(/<w:rPr>/g, `<w:rPr><w:sz w:val="${size}"/><w:szCs w:val="${size}"/>`);
    });
  } catch { return xml; }
}

// â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(show, msg = '', sub = '') {
  document.getElementById('loadingBar').classList.toggle('show', show);
  if (msg) document.getElementById('loadingMsg').textContent = msg;
  document.getElementById('loadingSub').textContent = sub;
  document.getElementById('btnExtract').disabled = show;
}

let _tt;
function toast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  clearTimeout(_tt);
  _tt = setTimeout(() => el.classList.remove('show'), 3600);
}

function downloadBlob(blob, filename) {
  const a = Object.assign(document.createElement('a'),
    { href: URL.createObjectURL(blob), download: filename });
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 2000);
}

function today() { return new Date().toISOString().slice(0, 10); }

function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')
                .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
